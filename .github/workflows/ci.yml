name: .NET CI

on:
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ "main", "master" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build (Debug)
      run: dotnet build --no-restore --configuration Debug
      
    - name: Build (Release)
      run: dotnet build --no-restore --configuration Release
    
    - name: Verify API Credentials
      env:
        STREAM_API_KEY: ${{ secrets.STREAM_API_KEY }}
        STREAM_API_SECRET: ${{ secrets.STREAM_API_SECRET }}
      run: |
        echo "ğŸ” Checking API credentials..."
        
        if [ -z "$STREAM_API_KEY" ]; then
          echo "âŒ STREAM_API_KEY is missing or empty"
          echo "   Please check that the secret 'STREAM_API_KEY' is set in repository settings"
        else
          echo "âœ… STREAM_API_KEY is available (${#STREAM_API_KEY} characters)"
        fi
        
        if [ -z "$STREAM_API_SECRET" ]; then
          echo "âŒ STREAM_API_SECRET is missing or empty"
          echo "   Please check that the secret 'STREAM_API_SECRET' is set in repository settings"
        else
          echo "âœ… STREAM_API_SECRET is available (${#STREAM_API_SECRET} characters)"
        fi
        
        if [ -n "$STREAM_API_KEY" ] && [ -n "$STREAM_API_SECRET" ]; then
          echo "âœ… API credentials are available from repository secrets"
          echo "API Key length: ${#STREAM_API_KEY} characters"
          echo "API Secret length: ${#STREAM_API_SECRET} characters"
        else
          echo "âŒ API credentials are missing"
          exit 1
        fi
    
    - name: Run Tests
      env:
        STREAM_API_KEY: ${{ secrets.STREAM_API_KEY }}
        STREAM_API_SECRET: ${{ secrets.STREAM_API_SECRET }}
        CONFIGURATION: Debug
      run: |
        echo "Running all tests with API credentials from repository secrets"
        make test
    
    - name: Check for warnings
      run: |
        echo "Checking for build warnings..."
        dotnet build --no-restore --configuration Release --verbosity normal 2>&1 | tee build.log
        if grep -q "warning" build.log; then
          echo "âŒ Build warnings found:"
          grep "warning" build.log
          exit 1
        else
          echo "âœ… No build warnings found"
        fi
    
    - name: Test NuGet package creation
      run: |
        echo "Testing NuGet package creation..."
        dotnet pack src/stream-feed-net.csproj --configuration Release --no-build --output ./test-packages
        ls -la ./test-packages/
        echo "âœ… NuGet package created successfully" 